<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro</title>
  <link rel="stylesheet" href="./css/reset.css" />
  <link rel="stylesheet" href="./css/login.css" />
  <link rel="icon" href="./assets/imgs/iconViolao.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="preconnect" href="https://fonts.gstatic.com" />
</head>

<body>

  <div class="containerLogin">

    <div class="imgCaixaCadastro">
      <img src="./assets/imgs/cadastro/telaLogin.jpg">
    </div>

    <div class="conteudoCaixa">

      <div class="formulario">
        <h2>Cadastro</h2>
        <form>
          <div class="inputCaixa">
            <span>Nome</span>
            <input type="text" id="ipt_nome" placeholder="Chico Buarque" oninput="limparMsgErro('nome')"/>
            <div id="msgNome"></div>
          </div>

          <div class="inputCaixa">
            <span>Email</span>
            <input type="text" id="ipt_email" placeholder="seuemail@email.com" oninput="limparMsgErro('email')"/>
            <div id="msgEmail"></div>
          </div>
          
          <div class="inputCaixa">
            <span>Senha</span>
            <input type="password" id="ipt_senha" placeholder="Senha" oninput="limparMsgErro('senha')"/>
            <div id="msgSenha"></div>
          </div>

          <div class="esqueceuSenha">
            <label> <input type="checkbox" onclick="mostrarSenha()"/> Mostrar senha </label>
          </div>

          <div class="inputCaixa">
            <button type="button" onclick="cadastrar()">Cadastrar-se</button>
            <div id="div_aguardar" class="loadingGif">
              <img src="assets/imgs/loading.gif">
            </div>
          </div>

          <div id="div_msg"></div>
        </form>

        <div class="setaVoltar">
          <a href="login.html"> 
            <i class="fa-solid fa-arrow-left"></i>
            <h5>Voltar página</h5>
          </a>
        </div>
      </div>
    </div>
  </div>

  <script src="./js/sessao.js"></script>
  <script src="./js/validacoes.js"></script>
</body>
</html>
<script>

  var listaObrigatoria = ['!', '@', '#', '$', '%', '*', '(', ')'];
  function cadastrar() {

    var nomeVar = ipt_nome.value;
    var emailVar = ipt_email.value;
    var senhaVar = ipt_senha.value;

    var erro = false;
    var contemCaracterEspecial = false;

    if (nomeVar == "" ) {
      ipt_nome.style.border = `1px solid red`;
      msgNome.innerHTML = `<span style="color: red; font-weight: 600;">Preencha o campo Nome! </span>`; 
      erro = true;
    } else {
      ipt_nome.style.border = `1px solid green`;
    }

    if (emailVar == "") {
      ipt_email.style.border = `1px solid red`;
      msgEmail.innerHTML = `<span style="color: red; font-weight: 600;"> Preencha o campo Email! </span>`;
      erro = true;
    } else {
      if (emailVar.endsWith('@gmail.com') || emailVar.endsWith('@hotmail.com') || emailVar.endsWith('@outlook.com') || emailVar.endsWith('@yahoo.com') || emailVar.endsWith('@sptech.school') || emailVar.endsWith('@email.com') || emailVar.endsWith('@gov.br')) {
        ipt_email.style.border = `1px solid green`;
      } else {

        msgEmail.innerHTML = `<strong> <span style="color: red; font-weight: 600;"> Insira um email válido! </span> </strong>`;
        ipt_email.style.border = `1px solid red`;
        erro = true;
      }
    }

    for (var i = 0; i < listaObrigatoria.length; i++) {

      if (senhaVar.includes(listaObrigatoria[i])) {
        contemCaracterEspecial = true;
      }
    }

    if (senhaVar == "") {

      ipt_senha.style.border = `1px solid red`;
      msgSenha.innerHTML = `<span style="color: red; font-weight: 600;"> Preencha o campo Senha! </span>`;
      erro = true;
    } else if (senhaVar.length < 8) {

      ipt_senha.style.border = `1px solid red`;
      msgSenha.innerHTML = `<strong> <span style="color: red; font-weight: 600;"> Senha precisa conter no mínimo 8 caracteres! </span> </strong>`;
      erro = true;
    } else if (!contemCaracterEspecial) {

      ipt_senha.style.border = `1px solid red`;
      msgSenha.innerHTML = `<strong> <span style="color: red; font-weight: 600;"> Senha inválida! Falta algum caracterer especial '!' '@' '#' '$' '%' '*' '(' ')' </span> </strong>`;
      erro = true;
    } else {

      ipt_senha.style.border = `1px solid green`;
    }

    aguardar();
    
    // Enviando o valor da nova input
    fetch("/usuarios/cadastrar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
        body: JSON.stringify({
          // crie um atributo que recebe o valor recuperado aqui
          // Agora vá para o arquivo routes/usuario.js
          nomeServer: nomeVar,
          emailServer: emailVar,
          senhaServer: senhaVar,
        }),
      }).then(function (resposta) {
        console.log("resposta: ", resposta);

          if (resposta.ok) {
            div_msg.innerHTML = '<span style="color: green; font-weight: 600;">Cadastro realizado com sucesso! Redirecionando para login...</span>';

            finalizarAguardar();

            setTimeout (() => {
              window.location = "login.html";
            }, 2000);

            limparFormulario();
            finalizarAguardar();
          } else {
            throw "Houve um erro ao tentar realizar o cadastro!";
          }
        }).catch(function (resposta) {
          console.log(`#ERRO DE REDE: ${resposta}`);
         finalizarAguardar();
        });
        return false;
  }
  
</script>